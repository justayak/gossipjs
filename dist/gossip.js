define("config",[],function(){var e=!1,t=null,n=null,r=null,i=null,s=null,o=!1,u=!1;return{testingEnv:function(e){if(!(arguments.length>0))return u;u=e},debug:function(t){if(!(arguments.length>0))return e;e=t},set:function(e){if(typeof e=="undefined")throw"Missing options";if(!("name"in e))throw"Missing parameter {name}";if(!("host"in e))throw"Missing parameter {host}";if(!("port"in e))throw"Missing parameter {port}";if(!("bootstrapPort"in e))throw"Missing parameter {bootstrapPort}";t=e.host,i=e.name,s=e.port,n=e.bootstrapPort,o=!0},host:function(){if(!o)throw"Config not set!";return t},peers:function(){if(!o)throw"Config not set!";return r},bootstrapPort:function(){if(!o)throw"Config not set!";return n},name:function(){if(!o)throw"Config not set!";return i},port:function(){if(!o)throw"Config not set!";return s}}}),define("utils",["config"],function(e){return{isDefined:function(e){return e!==null&&typeof e!="undefined"},isString:function(e){return typeof e=="string"||e instanceof String},log:function(t){e.debug()&&console.log("[gossipjs]["+(new Date).toISOString().substr(12)+"]"+t)},randomInt:function(e,t){return Math.floor(Math.random()*(t-e+1))+e|0},removeFromBuffer:function(e,t){var n=0,r=t.length;for(;n<r;n++)if(t[n].addr===e){t.splice(n,1);break}return t},sanitize:function(e,t,n){var r=0,i=t.length,s=[],o;for(;r<i;r++)o=t[r].addr,o!==n&&!e.isRecentlyLost(o)&&s.push(t[r]);return s},probability:function(e){return e>=1?!0:e<=0?!1:Math.random()<e}}}),define("externals",[],function(){window.TxtLoader=function(){function e(e){var t={};return e&&"[object Function]"===t.toString.call(e)}function t(t){if("undefined"==typeof t)throw"TxtLoader: get - options are mandatory";if("undefined"==typeof t.success)throw"TxtLoader: No success-callback set";if(!e(t.success))throw"TxtLoader: success must be a function";var n=t.success,r=null;"failure"in t&&e(t.failure)&&(r=t.failure);var i=this;"undefined"!=typeof t.ctx&&(i=t.ctx);var s="application/json";return"undefined"!=typeof t.mime&&(s=t.mime),{ctx:i,success:n,fail:r,mime:s}}if("undefined"==typeof XMLHttpRequest)throw"TxtLoader: TxtLoader is not supported by this browser";return{get:function(e,n){var r=t(n),i=r.ctx,s=r.fail,o=r.success,u=new XMLHttpRequest;u.open("GET",e),u.onreadystatechange=function(){200!==u.status?null!==s&&2===u.readyState&&s.call(i,u.status):4===u.readyState&&o.call(i,u.responseText)},u.send()},post:function(e,n,r){r=t(r);var i=r.ctx,s=r.fail,o=r.success,u=new XMLHttpRequest;u.setRequestHeader("Content-type",r.mime),u.open("POST",e,!0),u.onreadystatechange=function(){200!==u.status?null!==s&&2===u.readyState&&s.call(i,u.status):4===u.readyState&&o.call(i,u.responseText)},u.send(n)}}}()}),define("messageType",[],function(){return{ARE_YOU_ALIVE:0,I_AM_ALIVE:1,PSS_BUFFER:2,PSS_BUFFER_PULL:3,TMAN_BUFFER:4,TMAN_BUFFER_PULL:5}}),define("LocalPeer",["utils","config","messageType"],function(e,t,n){function s(){var n=e.log,r=this.name=t.name(),s=t.port(),o=t.bootstrapPort(),a=t.host(),c=this;n("Establish as node {"+r+"}"),n("Connect to broker {"+a+":"+s+"}");var p=this.peer=new Peer(r,{host:a,port:s,path:"/b"});this.onMessageCallbacks=[],this.onLostPeerCallbacks=[];var v=!1,m="[]";TxtLoader.get("http://"+a+":"+o,{success:function(e){v=!0,m=e},failure:function(e){n("Bootstrapping failed! "+e),v=!0}}),p.on("error",function(e){switch(e.type){case"peer-unavailable":var t=0,r=c.onLostPeerCallbacks.length,i=c.onLostPeerCallbacks,s=e.message.substr(26);delete l[s],h[s]=Date.now();for(;t<r;t++)i[t].call(c,s);break;default:n(e)}}),p.on("open",function(){function e(){var t=0,r,s=[],o;if(v){r=m.replace("[","").replace("]","").split(","),o=r.length;for(;t<o;t++)r[t]!==c.name&&r[t].length>0&&s.push(r[t]);n("bootstrapping: "+JSON.stringify(s)),c.bootstrap=s,i.call(c,c,s);for(t=0,o=d.length;t<o;t++)d.call(c,c)}else setTimeout(e,100)}e(),setInterval(f,6e4),setInterval(u,2e3)}),p.on("connection",function(t){t.on("data",function(n){e.isString(n)&&(n=JSON.parse(n)),c._handleMessage(t.peer,n.type,n.payload)})})}function u(){function e(e,t){var n=r,i=0,s=r.onLostPeerCallbacks,u=r.onLostPeerCallbacks.length;t.timeoutThread=setTimeout(function(){if(t.missedCalls>=o){delete l[e],h[e]=Date.now();for(;i<u;i++)s[i].call(n,e)}else t.missedCalls=t.missedCalls+1},500)}var t,i,s=l,u=r;for(t in s)i=s[t],e(t,i),u.send(t,n.ARE_YOU_ALIVE,"*",{ignoreTS:!0});var a=Date.now(),f=[];for(t in h)a-h[t]>c&&f.push(t);var p=0,d=f.length;for(;p<d;p++)delete h[f[p]]}function f(){var t,n=0,r,i=Date.now(),s=[],o=l;for(t in o)i-o[t].ts>a&&(s.push(t),e.log("clean {"+t+"}"));r=s.length;for(;n<r;n++)delete o[s[n]]}function p(t,n,r){return e.isDefined(r)?{type:t,payload:n,piggy:r()}:{type:t,payload:n}}var r=null,i=null;s.prototype._handleMessage=function(e,t,r){var i=0,s=this.onMessageCallbacks.length,o=this.onMessageCallbacks,u;e in l&&(u=l[e],u.missedCalls=0,u.timeoutThread!==null&&(clearTimeout(u.timeoutThread),u.timeoutThread=null));switch(t){case n.ARE_YOU_ALIVE:this.send(e,n.I_AM_ALIVE,"-",{ignoreTS:!0});break;case n.I_AM_ALIVE:break;default:for(;i<s;i++)o[i].call(this,e,t,r)}};var o=3,a=12e4,l={},c=6e3,h={};s.prototype.isRecentlyLost=function(e){return e in h},s.prototype.send=function(t,n,r,i){var s=!1,o=null;e.isDefined(i)&&("ignoreTS"in i&&(s=i.ignoreTS),"piggybackFunc"in i&&(o=i.piggybackFunc));var u=l,a,f;t in u?(a=u[t],a.node.send(p(n,r,o)),s||(a.ts=Date.now())):(f=this.peer.connect(t),a={ts:Date.now(),node:f,missedCalls:0,timeoutThread:null},u[t]=a,f.on("open",function(){f.send(p(n,r,o))}))},s.prototype.onMessage=function(e){this.onMessageCallbacks.push(e)},s.prototype.onPeerLost=function(e){this.onLostPeerCallbacks.push(e)};var d=[];return{load:function(e){r===null?(r=new s,i=e):e.call(r,r,[])},get:function(){if(t.testingEnv())return{on:function(){},send:function(){},onPeerLost:function(){},onMessage:function(){}};if(r===null)throw"LocalPeer is not loaded!";return r},onReady:function(e){r===null?d.push(e):e.call(r,r)}}}),define("protocol/peerSamplingService",["utils","LocalPeer","messageType"],function(e,t,n){function d(d){var v=e.isDefined,b=p,w=[];v(d)&&(r=v(d.c)?d.c:r,i=v(d.T)?d.T:i,v(d.policy)&&(b=d.policy),w=v(d.bootstrap)?d.bootstrap:w,v(d.profile)&&(f=d.profile)),s=t.get(),s.onPeerLost(function(t){e.log("We lost connection to "+t);for(var n=0;n<o.length;n++)if(o[n].addr===t){o.splice(n,1);break}}),u=s.name;for(var x=0;x<w.length;x++)o.push({addr:w[x],hopCount:1});switch(b.SELECT_PEER){case a.SELECT_PEER.HEAD:h.selectPeer=function(e){return v(e)||(e=o),g.call(this,e,!0)};break;case a.SELECT_PEER.RAND:h.selectPeer=function(e){return v(e)||(e=o),m.call(this,e,!0)};break;case a.SELECT_PEER.TAIL:h.selectPeer=function(e){return v(e)||(e=o),y.call(this,e,!0)}}switch(b.SELECT_VIEW){case a.SELECT_VIEW.HEAD:h.selectView=function(e){return v(e)||(e=o),_.first(g.call(this,e,!1),r)};break;case a.SELECT_VIEW.RAND:h.selectView=function(e){return v(e)||(e=o),_.first(m.call(this,e,!1),r)};break;case a.SELECT_VIEW.TAIL:h.selectView=function(e){return v(e)||(e=o),_.first(y.call(this,e,!1),r)}}switch(b.VIEW_PROPAGATION){case a.VIEW_PROPAGATION.PULL:c=!0,l=!1;break;case a.VIEW_PROPAGATION.PUSH:l=!0,c=!1;break;case a.VIEW_PROPAGATION.PUSH_PULL:c=l=!0}setInterval(k,i),setInterval(A,i/r),s.onMessage(function(e,t,r){var i,o;switch(t){case n.PSS_BUFFER:for(i=0,o=S.length;i<o;i++)if(S[i].addr===e){S[i].view=E(r);return}S.push({addr:e,view:E(r)});break;case n.PSS_BUFFER_PULL:L.call(s,e,E(r))}})}function v(t,n){function a(e,t){var n=e.shift();if(n.addr in u){r(n.profile)&&!r(u[n.addr].profile)&&(u[n.addr].profile=n.profile);if(n.hopCount>=u[n.addr].hopCount)return!1}return u[n.addr]=n,t.push(n),!0}var r=e.isDefined,i=_.sortBy(t,function(e){return e.hopCount}),s=_.sortBy(n,function(e){return e.hopCount}),o=[],u={};while(i.length>0||s.length>0){var f=i[0],l=s[0];r(f)&&r(l)?f.hopCount<l.hopCount?a(i,o):a(s,o):r(l)?a(s,o):a(i,o)}return o}function m(e,t){var n=_.size(e);return n>0?t?_.sample(e).addr:_.sample(e,n>r?r:n):null}function g(e,t){var n=_.size(e);return n>0?t?_.min(e,function(e){return e.hopCount}).addr:_.first(_.sortBy(e,function(e){return e.hopCount}),n>r?r:n):null}function y(e,t){var n=_.size(e);return n>0?t?_.max(e,function(e){return e.hopCount}).addr:_.first(_.sortBy(e,function(e){return-e.hopCount}),n>r?r:n):null}function b(e){var t,n;for(n in e)t=e[n],t.hopCount+=1;return e}function w(t){if(t.length===0)return"#";var n="",r=0,i=t.length;for(;r<i;r++)n+=t[r].addr+"#"+t[r].hopCount,e.isDefined(t[r].profile)&&(n+="#"+JSON.stringify(t[r].profile)),r<i-1&&(n+="ยง");return n}function E(e){if(e==="#")return[];var t=[],n=e.split("ยง"),r=0,i=n.length,s,o;for(;r<i;r++)s=n[r].split("#"),o={addr:s[0],hopCount:parseInt(s[1],10)},s.length===3&&(o.profile=JSON.parse(s[2])),t.push(o);return t}function x(){return S.length>0?S.shift():null}function T(e,t,r){var i=n.PSS_BUFFER;r&&n.PSS_BUFFER_PULL,s.send(t,i,w(e))}function N(e){var t=0,n=e.length,r=[],i;for(;t<n;t++)i=e[t].addr,i!==u&&!s.isRecentlyLost(i)&&r.push(e[t]);return r}function C(){var e={addr:u,hopCount:0};return f!==null&&(e.profile=f),e}function k(){var e=h.selectPeer(),t,n=[];e!==null&&(l&&(t=C(),n=v(o,[t])),T(n,e),c)}function L(e,t){t=b(t),o=h.selectView(N(v(t,o)))}function A(){var e=x(),t,n,r,i;e!==null&&(t=e.addr,n=b(e.view),c&&(r=C(),i=v(o,[r]),T(i,t,!0)),i=v(n,o),o=h.selectView(N(i)))}var r=3,i=1e3,s=null,o=[],u=null,a={SELECT_PEER:{RAND:0,HEAD:1,TAIL:2},SELECT_VIEW:{RAND:0,HEAD:1,TAIL:2},VIEW_PROPAGATION:{PUSH:0,PULL:1,PUSH_PULL:2}},f=null,l=!1,c=!1,h={selectPeer:null,selectView:null},p={SELECT_PEER:a.SELECT_PEER.RAND,SELECT_VIEW:a.SELECT_VIEW.RAND,VIEW_PROPAGATION:a.VIEW_PROPAGATION.PUSH_PULL},S=[];return{init:d,getPeers:function(){return o},inner:{merge:v,rand:m,head:g,tail:y,increaseHopCount:b,serialize:w,deserialize:E}}}),define("protocol/t_man",["utils","LocalPeer","protocol/peerSamplingService","messageType"],function(e,t,n,r){function c(){return l.length>0?s(i,l)[0].addr:null}function h(e){return _.first(s(i,e),a)}function p(t,n){var r={},i=[],s,o=t.length,u=n.length,a;for(s=0;s<o;s++)a=t[s],r[a.addr]=a;for(s=0;s<u;s++)a=n[s],a.addr in r?e.isDefined(a.profile)&&(r[a.addr]=a):r[a.addr]=a;var f;for(f in r)i.push(r[f]);return i}function d(){return n.getPeers()}function v(e){return JSON.stringify(e)}function m(e){return JSON.parse(e)}function g(e,t){var n=r.TMAN_BUFFER;o.send(t,n,v(e))}function y(c){i=c.profile,s=c.rankingFunc,a=c.c||a,f=c.T||f;if(!e.isDefined(s)||!e.isDefined(i))throw"T-Man Node is not setup correctly: Ranking function or Profile is missing.";n.init({profile:i,bootstrap:c.bootstrap}),e.isDefined(c.bootstrap)&&(l=_.map(c.bootstrap,function(e){return{addr:e}})),o=t.get(),o.onPeerLost(function(t){l=e.removeFromBuffer(t,l)}),o.onMessage(function(e,t,n){var i,s;switch(t){case r.TMAN_BUFFER:for(i=0,s=b.length;i<s;i++)if(b[i].addr===e){b[i].view=m(n);return}b.push({addr:e,view:m(n)});break;case r.TMAN_BUFFER_PULL:S.call(o,e,m(n))}}),u=o.name,setInterval(E,f),setInterval(x,f/a)}function w(){return b.length>0?b.shift():null}function E(){var e=c(),t,n;e!==null&&(t={addr:u,profile:i},n=p(l,[t]),n=p(n,d()),g(n,e))}function S(t,n){var r=p(t,l);l=h(e.sanitize(o,r,u))}function x(){var t=w(),n,r,s,a;t!==null&&(r=t.view,s=t.addr,a={addr:u,profile:i},n=p(l,a),n=p(n,d()),g(n,s),n=p(r,l),l=h(e.sanitize(o,n,u)))}var i=null,s=null,o=null,u=null,a=3,f=800,l=[],b=[];return{init:y,getPeers:function(){return l},inner:{merge:p}}}),define("gui",["config","utils","LocalPeer","protocol/t_man","protocol/peerSamplingService"],function(e,t,n,r,i){return{init:function(){$(function(){$("#connectBtn").on("click",function(){var s=$("#me").val();if(s.length>0){e.set({name:s,host:"85.25.215.113",port:9e3,bootstrapPort:9001});var o=t.randomInt(1,99);$("#start").html("<h2>"+s+" ["+o+"]</h2>"),n.load(function(e,t){r.init({bootstrap:t,profile:o,rankingFunc:function(e,t){return _.sortBy(t,function(t){return"profile"in t?Math.abs(t.profile-e):Math.MAX_VALUE})}}),setInterval(function(){var e=i.getPeers(),t="<div>PeerSamplingService ["+e.length+"]</div>";for(var n=0;n<e.length;n++)t+=JSON.stringify(e[n])+"</br>";$("#data").html(t),e=r.getPeers();for(var n=0;n<e.length;n++)!("profile"in e[n]);e=_.sortBy(e,function(e){return e.profile}),t="<div>TMAN ["+e.length+"]</div>";for(var n=0;n<e.length;n++)t+=JSON.stringify(e[n])+"</br>";$("#tman").html(t)},900)})}})})}}}),requirejs.config({urlArgs:"bust="+(new Date).getTime(),baseUrl:"src",paths:{jQuery:"//code.jquery.com/jquery-2.0.3.min",underscore:"//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min",peer:"//cdn.peerjs.com/0.3/peer"}}),define("gossip",["jQuery","underscore","peer","utils","config","externals","LocalPeer","gui"],function(e,t,n,r,i,s,o,u){i.debug(!0),u.init()});