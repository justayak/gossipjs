<html>
    <head lang="en">
        <meta charset="UTF-8">
        <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
        <script src="gossip_utils.js"></script>
        <script src="gossip.js"></script>
        <script src="tman.js"></script>
    </head>
    <body>
        <div>
            <div id="start">
                You:
                <input id="me"/><button id="connectBtn">connect</button>
            </div>
            <div id="after">
                <div>
                    <div>
                        <input id="other"/>
                        <button id="otherBtn">connect</button>
                        <span id="others"></span>
                    </div>
                    <div>
                        <strong id="meFinal"></strong><br/>
                        <input id="msg"/>
                        <button id="sendBtn">send</button>
                    </div>
                    <div id="content">

                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>

        function addOther(other){
            $('#others').html($('#others').html() + ', ' + other);
        };

        function addMessage(msg){
            $('#content').html($('#content').html() + '<br/>' + msg);
        };

        $(function(){

            Gossip.options({
                debug: true
            });

            $('#after').hide();
            $('#connectBtn').on('click', function(){
                var name = $('#me').val();
                var profile = randomInt(0,15);
                if (name.length > 0) {
                    $('#after').show();
                    $('#meFinal').html(name + " - " + profile);
                    $('#start').hide();
                    Gossip.init({
                        name : name,
                        host : '85.25.215.113',
                        port : 9000
                    }, function(){

                        var TMan = Gossip.TMan.init({profile: profile, rankingFunction: function(x,nodes){
                            return _.sortBy(nodes, function(node){return Math.abs(x-node.profile);});
                        }});

                        $('#otherBtn').on('click', function(){
                            var other = $('#other').val();
                            if (other.length > 0) {
                                addOther(other);
                                Gossip.connect(other);
                            }
                        });

                        $('#sendBtn').on('click', function(){
                            var txt = $('#msg').val();
                            if (txt.length > 0) {
                                Gossip.broadcast(txt);
                                addMessage(txt);
                            }
                        });

                    });

                    /*
                    Gossip.onConnection(function(conn){
                        addOther(conn);
                    });

                    Gossip.onMessage(function(msg){
                        addMessage(msg);
                    });
                    */

                }
            });

        });

        function randomInt(min, max){
            return Math.floor(Math.random() * (max-min+1)) + min;
        }

    </script>
</html>
